# æ¨¡å‹ä¸‰ï¼šå¸¦äº¤äº’é¡¹çš„2 X 3 çš„å¤šå…ƒçº¿æ€§å›å½’

**äº¤äº’ä½œç”¨**ï¼š å½“æ¨¡å‹å­˜åœ¨ä¸¤ä¸ªæˆ–ä¸¤ä¸ªä»¥ä¸Šçš„è‡ªå˜é‡æ—¶ï¼Œäº¤äº’ä½œç”¨æ˜¯æŒ‡ä¸€ä¸ªè‡ªå˜é‡$X_1$å¯¹å› å˜é‡$Y$çš„å½±å“ä¼šéšç€è‡ªå˜é‡$X_2$ä¸åŒæ°´å¹³çš„å˜åŒ–è€Œæœ‰æ‰€å·®å¼‚ã€‚

å½“æˆ‘ä»¬è€ƒè™‘äº¤äº’æ•ˆåº”æ—¶ï¼Œæ¨¡å‹ä¸ä»…åŒ…å« â€œLabelâ€ å’Œ â€œMatchingâ€ çš„ç‹¬ç«‹ä¸»æ•ˆåº”ï¼Œè¿˜éœ€è¦åŠ å…¥å®ƒä»¬ä¹‹é—´çš„äº¤äº’ä½œç”¨ã€‚

- åŠ å…¥äº¤äº’é¡¹å¯ä»¥è§‚å¯Ÿ â€œLabelâ€ å’Œ â€œMatchingâ€ æ˜¯å¦å­˜åœ¨ç›¸äº’ä¾èµ–çš„å½±å“ï¼Œå³ â€œMatchingâ€ å¯¹ â€œSelfã€Friend å’Œ Strangerâ€ æ¡ä»¶çš„å½±å“æ˜¯å¦ä¸åŒã€‚é€šè¿‡å¼•å…¥äº¤äº’é¡¹ï¼Œæˆ‘ä»¬èƒ½å¤Ÿæ•æ‰å˜é‡ä¹‹é—´çš„ç›¸äº’å…³ç³»ã€‚

ğŸ¤”**éœ€è¦æ³¨æ„ï¼šä¸€æ—¦æˆ‘ä»¬æ¶‰åŠäº¤äº’ä½œç”¨ï¼Œéœ€è¦è°¨æ…åœ°è€ƒè™‘ç¼–ç æ–¹å¼çš„é€‰å–ä»¥åŠå‚æ•°çš„è§£è¯»ï¼Œæ­¤æ—¶ä¸åŒç¼–ç å¯èƒ½ä¼šå½±å“æœ€åçš„ç»“æœæ¨æ–­ã€‚**

## å¤šä¸ªç†è§£å˜é‡ä¸‹ï¼Œä¸åŒç¼–ç å’Œç ”ç©¶æ•ˆåº”çš„å…³ç³»

å¦‚å›¾æ‰€ç¤ºï¼Œè¡¨ä¸­åˆ—å‡ºäº† Treatment Coding å’Œ Sum Coding ä¸¤ç§å¸¸ç”¨çš„å› å­å˜é‡ç¼–ç æ–¹å¼ï¼Œå¹¶å±•ç¤ºäº†å®ƒä»¬åœ¨ç ”ç©¶ä¸»æ•ˆåº”å’Œäº¤äº’æ•ˆåº”æ—¶çš„ç‰¹ç‚¹ï¼š

![alt text](image-15.png)

> å‚è€ƒèµ„æ–™ï¼š
[çº¿æ€§ï¼ˆæ··åˆï¼‰æ¨¡å‹ä¸­å¦‚ä½•å¯¹å› å­å˜é‡äº‹å…ˆç”Ÿæˆè™šæ‹Ÿå˜é‡ - çŸ¥ä¹](https://zhuanlan.zhihu.com/p/103547646)

- è¿™é‡Œéœ€è¦æ³¨æ„ï¼šå¦‚æœæƒ³è¦çº¿æ€§å›å½’çš„åˆ†æç»“æœä¸æ–¹å·®åˆ†æä¿æŒä¸€è‡´ï¼Œç¼–ç çš„æ–¹å¼ä»¥åŠæ–¹å·®çš„é€‰å–ç­‰ç­‰éƒ½å¾ˆé‡è¦ï¼Œéœ€è¦ä¸¥æ ¼è€ƒè™‘ã€‚

**å“‘å˜é‡ç¼–ç è§„åˆ™**

å¢åŠ äº†äº¤äº’ä½œç”¨åçš„çº¿æ€§æ¨¡å‹çš„ç¼–ç è§„åˆ™åº”è¯¥æ˜¯ï¼š

1ã€ä¸»æ•ˆåº”çš„ç¼–ç è§„åˆ™ï¼š

- Labelï¼ˆ3 levelsï¼‰

(1)($X_{L1}=1$)è¡¨ç¤ºâ€œfriendâ€æ¡ä»¶ï¼›($X_{L1}=0$)è¡¨ç¤ºå…¶ä»–æ¡ä»¶

(2)($X_{L2}=1$)è¡¨ç¤ºâ€œstrangerâ€æ¡ä»¶ï¼›($X_{L2}=0$)è¡¨ç¤ºå…¶ä»–æ¡ä»¶

(3)â€œselfâ€æ¡ä»¶ä¸ºåŸºçº¿æ°´å¹³ï¼Œä¸éœ€è¦å•ç‹¬ç¼–ç ï¼ˆéšå«åœ¨ï¼ˆ$X_{L1}=0ï¼ŒX_{L2}=0$ï¼‰å½“ä¸­ï¼‰

- Matchingï¼ˆ2 levelsï¼‰

(1)($X_{M1}$=1)è¡¨ç¤ºâ€œnonmatchingâ€æ¡ä»¶

(2)($X_{M1}$=0)è¡¨ç¤ºâ€œmatchingâ€æ¡ä»¶ï¼ˆåŸºçº¿æ°´å¹³ï¼‰

2ã€äº¤äº’é¡¹çš„ç¼–ç è§„åˆ™ï¼š

- äº¤äº’é¡¹($X_{L1}Â·X_{M1}$):

(1)å½“($X_{L1}=1$)ä¸”($X_{M1}=1$)æ—¶ï¼Œäº¤äº’é¡¹($X_{L1}Â·X_{M1}=1$)

(2)å¦åˆ™ï¼Œ($X_{L1}Â·X_{M1}=0$)

- äº¤äº’é¡¹($X_{L2}Â·X_{M1}$):

(1)å½“($X_{L2}=1$)ä¸”($X_{M1}=1$)æ—¶ï¼Œäº¤äº’é¡¹($X_{L2}Â·X_{M1}=1$)

(2)å¦åˆ™ï¼Œ($X_{L2}Â·X_{M1}=0$)

## Treatmentç¼–ç çŸ©é˜µ(æœ‰äº¤äº’é¡¹)

<style>
.center 
{
  width: auto;
  display: table;
  margin-left: auto;
  margin-right: auto;
}
</style>
<div class="center">

|Label|Matching|æˆªè·ï¼ˆbaselineï¼‰|$X_{L1}$|$X_{L2}$|$X_{M1}$|$X_{L1}Â·X_{M1}$|$X_{L2}Â·X_{M1}$|
| :-----------: | :-----------: | :-----------: | :-----------: | :-----------: | :-----------: |:-----------: | :-----------: |
|self|matching|1|0|0|0|0|0|
|self|nonmatching|1|0|0|1|0|0|
|friend|matching|1|1|0|0|0|0|
|friend|nonmatching|1|1|0|1|1|0|
|stranger|matching|1|0|1|0|0|0|
|stranger|non-matching|1|0|1|1|0|1|
</div>

é€šè¿‡è¡¨æ ¼ä¸­å„è¡Œç¼–ç å‚æ•°ä¹‹é—´çš„ç›¸å‡å¯ä»¥å¾—å‡ºå¯¹åº”çš„æ•ˆåº”ï¼Œä¾‹å¦‚ï¼š

- selfæ¡ä»¶çš„nonmatchingæ°´å¹³ä¸matchingæ°´å¹³ä¹‹å·®ï¼š$X_{M1}$

- friendæ¡ä»¶çš„nonmatchingæ°´å¹³ä¸matchingæ°´å¹³ä¹‹å·®ï¼š$X_{M1}+X_{L1}Â·X_{M1}$

- friendæ¡ä»¶çš„ï¼ˆnonmatchingä¸matchingä¹‹å·®ï¼‰ ä¸ ï¼ˆselfæ¡ä»¶çš„nonmatchingä¸matchingä¹‹å·®ï¼‰ ä¹‹é—´çš„å·®å¼‚ï¼š$X_{L1}Â·X_{M1}$

**æ¨¡å‹è®¾å®š**

åœ¨äº†è§£å“‘å˜é‡ä¹‹åï¼Œæˆ‘ä»¬å°±å¯ä»¥å¼€å§‹è¿›è¡Œæ¨¡å‹æ‹Ÿåˆå’Œæ¨æ–­äº†ã€‚

æœ‰äº¤äº’é¡¹çš„ 2 X 3 çš„çº¿æ€§å›å½’æ¨¡å‹è¡¨è¾¾ä¸ºï¼š

$$
Y=\beta_0+\beta_1Â·X_{L1}+\beta_2Â·X_{L2}+\beta_3Â·X_{M1}+\beta_4Â·(X_{L1}Â·X_{M1})+\beta_5Â·(X_{L2}Â·X_{M1})+\epsilon_i
$$

**æ¨¡å‹å…ˆéªŒè®¾ç½®**

åœ¨å…ˆå‰è®¾å®šçš„å…ˆéªŒåŸºç¡€ä¸Šï¼ŒåŠ å…¥å¯¹$\beta_4å’Œ\beta_5$å…ˆéªŒåˆ†å¸ƒçš„è®¾ç½®ï¼š

$$
\beta_4 \sim N(0,1^2),\beta_5 \sim N(0,1^2)
$$

**æ¨¡å‹æ‹Ÿåˆå’Œæ¨æ–­**

```python
# è½¬æ¢åˆ†ç±»å˜é‡ä¸ºå“‘å˜é‡
X1 = (df['Label'] == 'Friend').astype(int)
X2 = (df['Label'] == 'Stranger').astype(int)

# Matching æ¡ä»¶çš„å“‘å˜é‡
Matching = (df['Matching'] == 'matching').astype(int)  

# Friend å’Œ Matching çš„äº¤äº’
Interaction_1 = X1 * Matching  
# Stranger å’Œ Matching çš„äº¤äº’
Interaction_2 = X2 * Matching
```

```python
import pymc as pm

with pm.Model() as model3:
    # å®šä¹‰å…ˆéªŒåˆ†å¸ƒ
    beta_0 = pm.Normal('beta_0', mu=5, sigma=2)  
    beta_1 = pm.Normal('beta_1', mu=0, sigma=1) 
    beta_2 = pm.Normal('beta_2', mu=0, sigma=1)  
    beta_3 = pm.Normal('beta_3', mu=0, sigma=1)  
    beta_4 = pm.Normal('beta_4', mu=0, sigma=1) 
    beta_5 = pm.Normal('beta_5', mu=0, sigma=1)  
    sigma = pm.Exponential('sigma', lam=0.3)  
    
    # çº¿æ€§æ¨¡å‹
    mu = (beta_0 + beta_1 * X1 + beta_2 * X2 + beta_3 * Matching +
          beta_4 * Interaction_1 + beta_5 * Interaction_2)
    
    # è§‚æµ‹æ•°æ®çš„ä¼¼ç„¶å‡½æ•°
    likelihood = pm.Normal('Y_obs', mu=mu, sigma=sigma, observed=df['RT_sec'])
```

**è¿›è¡ŒåéªŒé‡‡æ ·**

```python
with model3:
    model3_trace = pm.sample(draws=5000,                   # ä½¿ç”¨mcmcæ–¹æ³•è¿›è¡Œé‡‡æ ·ï¼Œdrawsä¸ºé‡‡æ ·æ¬¡æ•°
                             tune=1000,                    # tuneä¸ºè°ƒæ•´é‡‡æ ·ç­–ç•¥çš„æ¬¡æ•°ï¼Œå¯ä»¥å†³å®šè¿™äº›ç»“æœæ˜¯å¦è¦è¢«ä¿ç•™
                             chains=4,                     # é“¾æ•°
                             discard_tuned_samples=True,  # tuneçš„ç»“æœå°†åœ¨é‡‡æ ·ç»“æŸåè¢«ä¸¢å¼ƒ
                             random_seed=84735)           # åéªŒé‡‡æ ·
```

**MCMCè¯Šæ–­å’ŒåéªŒæ¨æ–­**

```python
az.summary(model3_trace)
```

![alt text](image-16.png)

ä½¿ç”¨ ROPE+HDI å¯¹å‚æ•°è¿›è¡Œæ£€éªŒ:

```python
# å®šä¹‰ ROPE åŒºé—´ï¼Œæ ¹æ®ç ”ç©¶çš„éœ€è¦æŒ‡å®šå®é™…ç­‰æ•ˆèŒƒå›´
rope_interval = [-0.05, 0.05]

# ç»˜åˆ¶åéªŒåˆ†å¸ƒï¼Œæ˜¾ç¤º HDI å’Œ ROPE
az.plot_posterior(
    model3_trace,
    var_names=["beta_4", "beta_5"],
    hdi_prob=0.95,
    rope=rope_interval,
    figsize=(12, 3),
    textsize=12
)

plt.show()
```

![alt text](image-17.png)

- å¯ä»¥çœ‹å‡ºï¼Œ$\beta_4å’Œ\beta_5$çš„HDIä¸ROPEåŒºé—´é‡å éå¸¸å¤§ï¼Œè¡¨æ˜æ²¡æœ‰äº¤äº’ä½œç”¨ã€‚

ä½¿ç”¨è´å¶æ–¯å› å­è¿›è¡Œå·®å¼‚æ£€éªŒï¼š

```python
# è¿›è¡Œè´å¶æ–¯å› å­è®¡ç®—ï¼Œéœ€è¦é‡‡æ ·å…ˆéªŒåˆ†å¸ƒ
with model3:
    model3_trace.extend(pm.sample_prior_predictive(5000, random_seed=84735) )

fig, axes = plt.subplots(1,2, figsize=(9, 3.5))

# ç»˜åˆ¶è´å¶æ–¯å› å­å›¾
# beta4
ax = axes[0]
az.plot_bf(model3_trace, var_name="beta_4", ref_val=0, ax=ax)
ax.set_xlim(-0.5, 0.5) 
# beta5
ax = axes[1]
az.plot_bf(model3_trace, var_name="beta_5", ref_val=0, ax=ax)
ax.set_xlim(-0.5, 0.5) 

# å»é™¤ä¸Šæ¡†çº¿å’Œå³æ¡†çº¿
sns.despine()
plt.show()
```

![alt text](image-18.png)

- $\beta_4å’Œ\beta_5çš„BF_{01}$åœ¨10~20ä¹‹é—´ï¼Œå³æœ‰è¾ƒå¼ºçš„è¯æ®æ”¯æŒä¸å­˜åœ¨äº¤äº’ä½œç”¨ã€‚

**åéªŒé¢„æµ‹**

```python
with model3:
    model3_ppc = pm.sample_posterior_predictive(model3_trace, random_seed=84735)
```

```python
az.plot_ppc(model3_ppc, num_pp_samples = 500)
```

![alt text](image-19.png)

```python
import xarray as xr

# å¯¼å…¥çœŸå®çš„è‡ªå˜é‡
X1 = xr.DataArray((df['Label'] == 'Friend').astype(int))
X2 = xr.DataArray((df['Label'] == 'Stranger').astype(int))
Matching = xr.DataArray((df['Matching'] == 'matching').astype(int))
Interaction_1 = X1 * Matching
Interaction_2 = X2 * Matching

model3_trace.posterior["y_model"] = model3_trace.posterior["beta_0"] + \
    (model3_trace.posterior["beta_1"] * X1) + \
    (model3_trace.posterior["beta_2"] * X2) + \
    (model3_trace.posterior["beta_3"] * Matching) + \
    (model3_trace.posterior["beta_4"] * Interaction_1) + \
    (model3_trace.posterior["beta_5"] * Interaction_2)

df["model3_prediction"] = model3_trace.posterior.y_model.mean(dim=["chain","draw"]).values
```

```python
df['Label'] = df['Label'].astype(str)
```

```python
fig, axes = plt.subplots(1, 2, figsize=(8, 4))

# ç»˜åˆ¶model3é¢„æµ‹ç»“æœ
plot_prediction(df, "model3_prediction", ax=axes[0])
axes[0].set_title("Model 3")

# ç»˜åˆ¶model2é¢„æµ‹ç»“æœ
plot_prediction(df, "model2_prediction", ax=axes[1])
axes[1].set_title("Model 2")

# æ˜¾ç¤ºå›¾åƒ
sns.despine()
plt.tight_layout()
plt.show()
```

![alt text](image-20.png)

- æˆ‘ä»¬å¯ä»¥è§‚å¯Ÿåˆ°Model3çš„çº¢ç‚¹ï¼ˆé¢„æµ‹å€¼ï¼‰ç›¸æ¯”äºModel2æ›´åŠ æ‹Ÿåˆæ•°æ®çš„é›†ä¸­è¶‹åŠ¿ï¼Œè¡¨æ˜å°†äº¤äº’ä½œç”¨çº³å…¥è€ƒè™‘çš„Model3ç›¸æ¯”äºæ²¡æœ‰è€ƒè™‘äº¤äº’çš„Model2æœ‰äº†ä¸€ä¸ªæ˜¾è‘—çš„æå‡ã€‚

**æ¨¡å‹è§£è¯»ä¸ç»“è®º**

é€šè¿‡è´å¶æ–¯å›å½’æ¨¡å‹çš„åéªŒåˆ†å¸ƒï¼Œæˆ‘ä»¬å¯ä»¥æ¨æ–­ä»¥ä¸‹å‡ ä¸ªæ–¹é¢ï¼š

- ååº”æ—¶é—´ä¸æ ‡ç­¾çš„å…³ç³»ï¼šæ ¹æ®$\beta_2å’Œ\beta_3$çš„ä¼°è®¡å€¼ï¼Œæˆ‘ä»¬å¯ä»¥åˆ¤æ–­ä¸åŒæ ‡ç­¾æ¡ä»¶ä¸‹ååº”æ—¶é—´çš„å·®å¼‚ï¼ˆè‡ªæˆ‘å¯¹æ¯”å…¶ä»–æ ‡ç­¾ï¼‰ã€‚

- åŒ¹é…æ¡ä»¶çš„å½±å“ï¼šé€šè¿‡$\beta_1$ï¼Œæˆ‘ä»¬å¯ä»¥åˆ¤æ–­æ˜¯å¦åŒ¹é…æ¡ä»¶ä¼šæ˜¾è‘—å½±å“ååº”æ—¶é—´ã€‚

- äº¤äº’æ•ˆåº”ï¼šé€šè¿‡$\beta_4å’Œ\beta_5$çš„ä¼°è®¡ï¼Œæˆ‘ä»¬å¯ä»¥äº†è§£åŒ¹é…æ¡ä»¶ä¸æ ‡ç­¾ä¹‹é—´çš„äº¤äº’ä½œç”¨æ˜¯å¦æ˜¾è‘—ï¼Œå°¤å…¶æ˜¯åœ¨è‡ªæˆ‘ä¸ä»–äººæ ‡ç­¾çš„ååº”æ—¶é—´æ˜¯å¦æœ‰æ˜¾è‘—å·®å¼‚ã€‚

ğŸ¤”æ€è€ƒé¢˜ï¼šè´å¶æ–¯çº¿æ€§å›å½’æ¨¡å‹ä¸ä¼ ç»Ÿçº¿æ€§å›å½’æ¨¡å‹å¾—åˆ°çš„ç»“è®ºæ˜¯å¦ä¸€è‡´ï¼Ÿ

***æ³¨æ„ï¼š***

- ä¸ä¼ ç»Ÿå‡è®¾æ£€éªŒä¸åŒï¼Œåœ¨è´å¶æ–¯å»ºæ¨¡çš„è¿‡ç¨‹ä¸­æˆ‘ä»¬éœ€è¦æ ¹æ®å…·ä½“çš„é—®é¢˜æƒ…å¢ƒè¯¦ç»†è€ƒè™‘æ¯ä¸€ä¸ªæ­¥éª¤ã€‚ä¾‹å¦‚ï¼Œæˆ‘ä»¬è¯¥å¦‚ä½•è®¾ç½®ROPEï¼Ÿåœ¨è®¸å¤šçŸ¥è§‰å®éªŒç ”ç©¶ä¸­ï¼Œå¯èƒ½ç›¸å·®å‡ æ¯«ç§’å°±ä¼šå‡ºç°æ˜¾è‘—å·®å¼‚ï¼Œé‚£ä¹ˆæ­£è´Ÿ50msçš„ROPEåœ¨è¿™ç§å®éªŒæƒ…å¢ƒä¸‹å¯èƒ½å°±æ˜¾å¾—ä¸æ˜¯é‚£ä¹ˆåˆç†ã€‚æ­¤å¤–ï¼Œè¿˜éœ€è¦è€ƒè™‘å…ˆéªŒè®¾ç½®çš„æ˜¯å¦åˆç†ç­‰ç­‰é—®é¢˜ã€‚

