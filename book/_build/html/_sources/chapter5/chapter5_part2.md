# Metropolis-Hastings(MH)ç®—æ³•

åœ¨åˆšæ‰çš„ä¾‹å­ä¸­ï¼Œæˆ‘ä»¬å·²ç»æ¶‰åŠåˆ° MH ç®—æ³•æœ€æœ´ç´ çš„æ€æƒ³ï¼š

åéªŒåˆ†å¸ƒæ¨¡å‹å¯ä»¥é€šè¿‡å…¬å¼è¿›è¡Œæ¨å¯¼å¾—åˆ°ï¼Œç„¶è€Œæ— æ³•å¯¹å®ƒè¿›è¡Œç›´æ¥é‡‡æ ·ã€‚

æˆ‘ä»¬å¯ä»¥æ ¹æ®åéªŒæ¨¡å‹ y è½´çš„å¤§å°æ¥å†³å®š x è½´å‚æ•°çš„æ•°é‡ã€‚

- ä¾‹å¦‚ï¼Œæˆ‘ä»¬å‡åŒ€çš„ä»å‚æ•°çš„èŒƒå›´ï¼ˆx~[0,1]ï¼‰ä¸­æŠ½å–10000ä¸ªå‚æ•°æ ·æœ¬$\mu_i$ï¼Œç„¶åæˆ‘ä»¬è®¡ç®—å¯¹äºæ¯ä¸ª$\mu_i$çš„$f(\mu_i)$çš„å¤§å°ï¼Œ$f(\mu_i)$è¶Šå¤§é‚£ä¹ˆ$\mu_i$è¢«ä¿ç•™çš„å¯èƒ½æ€§è¶Šé«˜ã€‚

- æ­£å¦‚ä¹‹å‰æåˆ°ï¼Œè®¡ç®—$f(\mu_i)$æ˜¯æ¯”è¾ƒå›°éš¾çš„ï¼Œæˆ‘ä»¬å¯ä»¥è®¡ç®—éæ ‡å‡†åŒ–çš„$f(\mu_i)$ã€‚

æ­¤å¤–ï¼Œç›´æ¥åœ¨[0,1]ä¸­å‡åŒ€çš„é‡‡æ ·æ•ˆç‡å¤ªä½ï¼Œæˆ‘ä»¬åœ¨æ¥ä¸‹æ¥ä¼šåˆ©ç”¨ MCMC çŠ¶æ€è½¬ç§»çš„æ€§è´¨æ¥æé«˜é‡‡æ ·æ•ˆç‡ã€‚

æ¥ä¸‹æ¥ï¼Œæˆ‘ä»¬æ¥ä½“éªŒä¸€ä¸‹è¿™ä¸ªå¥‡å¦™çš„è¿‡ç¨‹ï¼š

## å»ºè®®åˆ†å¸ƒ(proposed distribution)

ä¸ºäº†æé«˜é‡‡æ ·æ•ˆç‡ï¼Œæˆ‘ä»¬ä¸ä¼šç›´æ¥ä»ä¸€ä¸ªåˆ†å¸ƒä¸­è¿›è¡Œå¤§é‡é‡‡æ ·ï¼Œå†è¿›è¡Œç­›é€‰(ä¹Ÿè¢«ç§°ä¸ºæ‹’ç»)ï¼Œè¿™ç§æ–¹å¼åœ¨å¤æ‚åˆ†å¸ƒä¸­æ•ˆç‡éå¸¸ä½ã€‚

- ä¹Ÿå°±æ˜¯è¯´ï¼Œå¦‚ä½•æ ¹æ®å½“å‰çš„é‡‡æ ·å€¼ï¼Œå»proposeä¸‹ä¸€æ¬¡é‡‡æ ·çš„å€¼ï¼Ÿ

å› æ­¤åœ¨ MCMC ä¸­ï¼Œæˆ‘ä»¬ä¼šæ„é€ ä¸€ä¸ªå»ºè®®åˆ†å¸ƒ (proposed distribution)$q(x)$ï¼Œç„¶ååˆ©ç”¨ MCMC çŠ¶æ€è½¬ç§»çš„æ€§è´¨æ¥è¿›è¡Œé‡‡æ ·ã€‚

é€šè¿‡å»ºè®®åˆ†å¸ƒï¼Œæˆ‘ä»¬å¯ä»¥åœ¨ MCMC çš„çŠ¶æ€è½¬ç§»è¿‡ç¨‹ä¸­æ„é€ å‡ºä¸€æ¡é©¬å°”å¯å¤«é“¾ã€‚è¿™æ¡é“¾æœ€ç»ˆä¼šæ”¶æ•›äºç›®æ ‡åéªŒåˆ†å¸ƒï¼Œä½¿å¾—ç”Ÿæˆçš„æ ·æœ¬æ¥è¿‘çœŸå®çš„ç›®æ ‡åˆ†å¸ƒã€‚

åœ¨åˆšæ‰æ‰€è®²çš„å¿ƒæƒ…çŠ¶æ€çš„å˜åŒ–è¿‡ç¨‹å®é™…ä¸Šå°±æ˜¯ä¸€ä¸ªå»ºè®®åˆ†å¸ƒçš„ä¾‹å­ã€‚

![alt text](image-4.png)

- ä¸¾ä¾‹ï¼šæˆ‘ä»¬éšæœºé€‰å–äº†ä¸€ä¸ªèµ·ç‚¹3ï¼Œç„¶åä»¥3ä¸ºä¸­å¿ƒè¿›è¡Œproposeï¼Œæ¯”å¦‚å¯¹3-1æˆ–3+1è¿›è¡Œä¸‹ä¸€æ¬¡çš„é€‰å–ï¼Œè¿™ä¸ªæ—¶å€™å°±æ¶‰åŠä¸€ä¸ªé—®é¢˜ï¼Œæˆ‘ä»¬å¯¹ä¸‹ä¸€æ¬¡é‡‡æ ·çš„æ¥å—ç­–ç•¥æ˜¯å¦‚ä½•çš„ï¼Ÿ

### æ¥å—ç‡(acceptance probability)

è™½ç„¶æˆ‘ä»¬äº†è§£äº†å½“å‰æ ·æœ¬å¯ä»¥æ ¹æ®ä¸Šä¸€æ¬¡çš„æ ·æœ¬ä»å»ºè®®åˆ†å¸ƒä¸­è¿›è¡Œé‡‡æ ·$\theta^n \sim Normal(\theta_k^{n-1},\sigma)$ã€‚

ç„¶è€Œï¼Œæˆ‘ä»¬å¦‚ä½•åˆ¤æ–­è¿™ä¸ªé‡‡æ ·æ˜¯å¦åˆç†å‘¢ï¼Ÿæ¢å¥è¯è¯´ï¼Œæˆ‘ä»¬éœ€è¦æ€è€ƒæ˜¯å¦ä¿ç•™æˆ–æ‹’ç»è¿™ä¸ªé‡‡æ ·ã€‚

ç°åœ¨ï¼Œæˆ‘ä»¬æ¥çœ‹ä¸€ä¸‹ä¸åŒçš„æ¥å—ç­–ç•¥ä¼šå¯¼è‡´ä»€ä¹ˆæ ·çš„æƒ…å†µ

### ä¸åŒæ¥å—ç­–ç•¥çš„å½±å“

- æˆ‘ä»¬å¯ä»¥è€ƒè™‘ä¸‰ç§æ¥å—å»ºè®®çš„æƒ…å†µï¼š

1ï¼šå§‹ç»ˆä¸æ¥å—æè®®ã€‚â€”â€”â€”â€”Tour2ï¼Œé‡‡æ ·å€¼å§‹ç»ˆä¸å˜ï¼Œä¸€ç›´åœç•™åœ¨åŒä¸€ä¸ªå€¼

2ï¼šå§‹ç»ˆæ¥å—æè®®ã€‚â€”â€”â€”â€”Tour3ï¼Œå®Œå…¨æ˜¯éšæœºçš„ï¼Œé‡‡æ ·ä¸ä¼šç¨³å®šåœ¨æŸä¸€ä¸ªèŒƒå›´

3ï¼šåªæœ‰å½“æè®®(n+1)çš„åéªŒå¯èƒ½æ€§å¤§äºå½“å‰(n)å€¼çš„åéªŒå¯èƒ½æ€§æ—¶ï¼Œæ‰æ¥å—æè®® ã€‚â€”â€”â€”â€”Tour1ï¼Œé€æ¸æ”¶æ•›åˆ°ä¸€ä¸ªç¨³å®šçš„å€¼ï¼Œä½†é‡‡æ ·åªåœç•™åœ¨$\mu=4$é™„è¿‘

æˆ‘ä»¬æ¥çœ‹ä¸€ä¸‹ä¸‰ç§æƒ…å†µå¯¹åº”ç”Ÿæˆçš„trace plotï¼š

![alt text](image-5.png)

è™½ç„¶Tour3çœ‹èµ·æ¥æ¯”å‰ä¸¤ç§æ›´é è°±ï¼Œä½†æ˜¯ä¼šäº§ç”Ÿä¸€ä¸ªé—®é¢˜ï¼šé‡‡æ ·åªåœç•™åœ¨ä¸€ä¸ªå›ºå®šçš„å€¼ä¸Šé¢ï¼Œè€Œä¸ä¼šå–åˆ°å…¶ä»–çš„å€¼ã€‚

- å› æ­¤ï¼Œè¿™ä¸‰ç§ç­–ç•¥éƒ½ä¸æ˜¯å¾ˆåˆé€‚ã€‚

**æ¥å—ç‡(acceptance probability)**

å¯è§ï¼Œé€‰æ‹©ä¸€ä¸ªåˆé€‚çš„æ¥å—ç­–ç•¥éå¸¸é‡è¦ã€‚è€Œæ¥å—ç‡ ($\alpha$, acceptance probability)å°±æ˜¯ä¸ºäº†è§£å†³è¿™ä¸ªé—®é¢˜ã€‚

é¦–å…ˆï¼Œæˆ‘ä»¬å°†ä»å»ºè®®æ¨¡å‹ä¸­æŠ½å–ä¸€ä¸ªæ–°çš„å‚æ•°$\theta^{n+1}$çš„æ¦‚ç‡ä¸º$q^{(\theta^{n+1}|\theta^n)}$

å¯¹äºæ˜¯å¦æ¥å—$\theta^{n+1}$ï¼Œæˆ‘ä»¬å®šä¹‰æ¥å—æ¦‚ç‡$\alpha$

$$
\alpha = min \{ 1,\frac{f(\theta^{n+1})L(\theta^{n+1}|y)}{f(\theta^n)L(\theta^n|y)} Ã— \frac{q(\theta^n|\theta^{n+1})}{q(\theta^{n+1}|\theta^n)} \}
$$

åˆ«çœ‹è¿™å…¬å¼å¾ˆå¤æ‚ï¼Œå…¶å®å¾ˆç®€å•:

æ•°çš„ä¸Šä¸‹åˆ†åˆ«ä»£è¡¨ä¸‹ä¸€ä¸ªå‚æ•°$\theta^{n+1}$å’Œå½“å‰å‚æ•°$\theta^n$çš„éæ ‡å‡†åŒ–åéªŒã€‚å³æˆ‘ä»¬ä¹‹å‰æåˆ°ï¼Œè¦é€šè¿‡éæ ‡å‡†åŒ–åéªŒæ¥åˆ¤æ–­æ˜¯å¦æ¥å—ä¸€ä¸ªå‚æ•°ã€‚

- å…¶ä¸­ï¼Œ$f(\theta)L(\theta|y)$ä¸ºéæ ‡å‡†åŒ–åéªŒ

- $q(\theta^n|\theta^{n+1})$éƒ¨åˆ†ä»£è¡¨äº†ä»å»ºè®®åˆ†å¸ƒä¸­é‡‡æ ·æ–°å‚æ•°çš„è¿‡ç¨‹ã€‚

- å¯ä»¥æƒ³è±¡ï¼Œ$\frac{f(\theta^{n+1})L(\theta^{n+1}|y)}{f(\theta^n)L(\theta^n|y)}$**å¤§äº1ä¸”å…¶å€¼è¶Šå¤§ï¼Œè¡¨æ˜ä¸‹ä¸€ä¸ªå‚æ•°$\theta^{n+1}$çš„åéªŒæ¦‚ç‡è¶Šå¤§ï¼Œå› æ­¤å®ƒè¶Šæœ‰å¯èƒ½è¢«æ¥å—ã€‚**

- å¦‚æœ$\frac{f(\theta^{n+1})L(\theta^{n+1}|y)}{f(\theta^n)L(\theta^n|y)}$**å°äº1ï¼Œåˆ™ä»£è¡¨ä¸‹ä¸€ä¸ªå‚æ•°$\theta^{n+1}$çš„åéªŒæ¦‚ç‡è¿‡å°ï¼Œå› æ­¤æˆ‘ä»¬è¦èˆå¼ƒå®ƒã€‚**

æ‰€ä»¥ï¼Œå¯¹äºæ˜¯å¦æ¥å—æˆ–æ‹’ç»æ–°çš„å‚æ•°$\theta^{n+1}$,åˆ™æœ‰ï¼š

$$
\theta^{(n+1)}=\theta^{(n+1)} with~probability~\alpha
$$

$$
\theta^{(n+1)}=\theta^{(n)} with~probability~1-\alpha
$$

- ä¹Ÿå°±æ˜¯å¦‚æœæˆ‘ä»¬ä¸æ¥å—æ–°çš„å‚æ•°ï¼Œé‚£æˆ‘ä»¬ç”¨åŸæ¥çš„å‚æ•°æ›¿ä»£ç°åœ¨çš„å‚æ•°ã€‚

- è¿™æ ·é¿å…äº†å‚æ•°é‡‡æ ·è¢«æµªè´¹ï¼Œå¹¶ä¸”ä½¿å¾—æ¦‚ç‡æ›´å¤§çš„å‚æ•°è¢«æ›´å¤šçš„é‡‡æ ·ã€‚

- æ€»çš„æ¥è¯´ï¼ŒMH ç®—æ³•åŒ…å«ä¸¤ä¸ªå…³é”®æ€æƒ³å’Œä¸¤ä¸ªå…³é”®æ­¥éª¤ï¼š

**ä¸¤ä¸ªå…³é”®æ€æƒ³**

1.æ ¹æ®éæ ‡å‡†åŒ–çš„åéªŒè¿›è¡Œå‚æ•°çš„æ¥å—æˆ–æ‹’ç»

2.æ ¹æ® MCMC çš„ç‰¹æ€§è®¾ç½®å»ºè®®åˆ†å¸ƒæ¥å®ŒæˆçŠ¶æ€è½¬ç§»

**ä¸¤ä¸ªå…³é”®æ­¥éª¤**

1.è®¾å®šå»ºè®®åˆ†å¸ƒ

2.æ ¹æ®å»ºè®®åˆ†å¸ƒçš„å‚æ•°ã€æœªæ ‡å‡†åŒ–åéªŒè®¡ç®—æ¥å—ç‡

## ä»£ç æ¼”ç¤º

```python
import numpy as np
import scipy.stats as st
import pandas as pd
import seaborn as sns
```

é¦–å…ˆï¼Œæˆ‘ä»¬å‡è®¾å½“å‰çš„å‚æ•°å€¼$\theta^n=3$ï¼Œç„¶åæˆ‘ä»¬æ ¹æ®è¯¥å‚æ•°è®¾å®šå»ºè®®åˆ†å¸ƒï¼Œå¹¶è¿›è¡Œä¸€æ¬¡æ–°çš„é‡‡æ ·ã€‚

- æ³¨æ„ï¼Œä¸ºäº†æ–¹ä¾¿æ¼”ç¤ºï¼Œæˆ‘ä»¬å°†å»ºè®®åˆ†å¸ƒ(æ­£æ€åˆ†å¸ƒ)çš„$\sigma$å›ºå®šä¸º1ã€‚

```python
#è®¾ç½®éšæœºç§å­ï¼Œä»¥ä¾¿é‡å¤
np.random.seed(2024) 

current = 3                             # å‡è®¾theta(n)ä¸º3

proposal = st.norm(current, 1).rvs()    # ä»å½“å‰æ­£æ€åˆ†å¸ƒï¼ˆå‡å€¼ä¸ºcurrentï¼Œæ ‡å‡†å·®ä¸º1ï¼‰ä¸­æŠ½å‡ºä¸€ä¸ªæ ·æœ¬ï¼Œrvsï¼ˆï¼‰é»˜è®¤åªæŠ½å–1ä¸ªæ ·æœ¬å€¼

print("ä»å»ºè®®åˆ†å¸ƒä¸­æ–°é‡‡æ · Î¸(n+1)ä¸ºï¼š",proposal)
```
> è¾“å‡ºï¼šä»å»ºè®®åˆ†å¸ƒä¸­æ–°é‡‡æ · Î¸(n+1)ä¸ºï¼š 4.668047321311954

æ¥ç€ï¼Œæˆ‘ä»¬æ ¹æ®æ–°é‡‡æ ·å¾—åˆ°çš„å‚æ•°è®¡ç®—å…¶ç›¸å…³çš„æ¥å—ç‡ã€‚

- æ³¨æ„ï¼Œæˆ‘ä»¬å‡è®¾å…ˆéªŒæ­£æ€åˆ†å¸ƒçš„å‚æ•°ä¸ºï¼šmean = 3, sigma = 1

- å¦å¤–ï¼Œæˆ‘ä»¬å‡è®¾ä¼¼ç„¶æ¨¡å‹ä»…åŒ…å«ä¸€ä¸ªæ•°æ®ï¼šY = 6

```python
# è®¾ç½®å…ˆéªŒ
prior = st.norm(loc = 3, scale = 1)
def likelihood(theta):
    Y = 6  # å‡è®¾æ•°æ® Y ä¸º 6
    return st.norm(loc = theta, scale = 0.75).pdf(Y)  # æ³¨æ„ï¼šè¿™é‡Œä¸ºæ–¹ä¾¿æ¼”ç¤ºå›ºå®š scale = 0.75
    

# è®¡ç®—å»ºè®®ä½ç½®(n+1)çš„æœªå½’ä¸€åŒ–çš„åéªŒæ¦‚ç‡å€¼ï¼ˆå…ˆéªŒ*ä¼¼ç„¶ï¼‰
proposal_posterior = prior.pdf(proposal) * likelihood(proposal)

# è®¡ç®—å½“å‰ä½ç½®(n)çš„æœªå½’ä¸€åŒ–çš„åéªŒæ¦‚ç‡å€¼ï¼ˆå…ˆéªŒ*ä¼¼ç„¶ï¼‰
current_posterior = prior.pdf(current) * likelihood(current)

# è®¡ç®—æ¥å—æ¦‚ç‡Î±ï¼Œä¸ºä¸¤è€…æ¦‚ç‡å€¼ä¹‹æ¯”
alpha = min(1,proposal_posterior/current_posterior)

# æ‰“å°å‡ºæ¥å—æ¦‚ç‡Î±
print("åéªŒæ¯”ä¸ºï¼š", proposal_posterior/current_posterior, ", alphaä¸º:", alpha)
```

> åéªŒæ¯”ä¸ºï¼š 153.2136146465854 , alphaä¸º: 1

æˆ‘ä»¬æ ¹æ®æ¥å—ç‡$\alpha$æ¥å†³å®šæ˜¯å¦æ¥å—å»ºè®®åˆ†å¸ƒçš„å‚æ•°ä½œä¸ºæ–°çš„é‡‡æ ·å€¼ã€‚

```python
# æ ¹æ®æ¥å—æ¦‚ç‡Î±è¿›è¡ŒæŠ½æ ·ï¼ŒæŠ½æ ·å†…å®¹ä¸ºå»ºè®®ä½ç½®å’Œå½“å‰ä½ç½®
next_stop = np.random.choice([proposal, current], 1, p=[alpha,1-alpha])

# æ‰“å°å‡ºä¸‹ä¸€ä¸ªä½ç½®çš„å€¼
next_stop[0]

#ä»ç¬¬ä¸€æ®µä»£ç æˆ‘ä»¬å¯ä»¥çœ‹åˆ°æ­¤æ—¶çš„æ¥å—æ¦‚ç‡Î±=1ï¼Œå› æ­¤æ¥å—äº†å»ºè®®å€¼ä½œä¸ºæˆ‘ä»¬çš„ä¸‹ä¸€ä¸ªå€¼
```
> è¾“å‡ºï¼š4.668047321311954

ä¸Šé¢å°±æ˜¯MHç®—æ³•çš„ä¸€æ¬¡è¿­ä»£æ¼”ç¤ºã€‚

**å®šä¹‰å•æ¬¡é‡‡æ ·å‡½æ•°**

æˆ‘ä»¬å¯ä»¥ç›´æ¥å®šä¹‰ä¸€ä¸ªå‡½æ•°ï¼Œå°†åˆšåˆšçš„æ“ä½œå…¨éƒ½ç»“åˆåœ¨ä¸€èµ·ï¼Œè¿™æ ·å½“æˆ‘ä»¬æƒ³è¿›è¡ŒæŠ½æ ·çš„æ—¶å€™ï¼Œä¸ç”¨é‡å¤å†™ä»£ç ã€‚

<style>
.center 
{
  width: auto;
  display: table;
  margin-left: auto;
  margin-right: auto;
}
</style>
<div class="center">

| | proposal | alpha |next_stop|
| :-----------: | :-----------: |:-----------: |:-----------:|
| 0 |3.091205|1|3.091205|

</div>

```python
# å˜æ¢ä¸åŒçš„éšæœºæ•°ç§å­ï¼Œå…¶å®ä¹Ÿæ˜¯ç”Ÿæˆä¸åŒçš„å»ºè®®å€¼
np.random.seed(83)
one_mh_iteration(current=3)
```
<style>
.center 
{
  width: auto;
  display: table;
  margin-left: auto;
  margin-right: auto;
}
</style>
<div class="center">

| | proposal | alpha |next_stop|
| :-----------: | :-----------: |:-----------: |:-----------:|
| 0 |3.849313|1|3.849313|

</div>

**å¤šæ¬¡é‡‡æ ·**

ä¸Šè¿°å‡½æ•°åªè¿›è¡Œäº†ä¸€æ¬¡é‡‡æ ·ï¼Œå³å½“å‰ä½ç½®ä¸º3æ—¶ï¼Œä¸‹ä¸€ä¸ªå¯èƒ½é‡‡æ ·çš„ç»“æœ

åŸºäºå½“å‰ä½ç½®ï¼Œæå‡ºä¸‹ä¸€ä¸ªé‡‡æ ·å€¼ï¼Œæ¥å—æˆ–æ‹’ç»å®ƒã€‚é‚£ä¹ˆæ–°çš„é‡‡æ ·å€¼å°±å˜æˆäº†å½“å‰ä½ç½®ï¼Œæˆ‘ä»¬éœ€è¦ä¸æ–­é‡å¤è¿™ä¸ªè¿‡ç¨‹

```python
def mh_tour(N, w = 1):

    """
    Nä¸ºè¿­ä»£æ¬¡æ•°ï¼Œwä¸ºå‡åŒ€åˆ†å¸ƒçš„ä¸€åŠå®½åº¦

    æˆ‘ä»¬åœ¨å•æ¬¡é‡‡æ ·å‡½æ•°çš„åŸºç¡€ä¸Šå åŠ äº†ä¸€ä¸ªå¾ªç¯
    å°†æ¯æ¬¡çš„é‡‡æ ·ç»“æœå­˜åœ¨mu[i]ä¸­ï¼Œ
    åœ¨æ¯æ¬¡é‡‡æ ·ç»“æŸåï¼Œå°†é‡‡æ ·ç»“æœæ›¿æ¢ä¸ºå½“å‰ä½ç½®

    è¿”å›å€¼ä¸ºè¿­ä»£æ¬¡æ•°ï¼Œå’Œæ¯æ¬¡é‡‡æ ·å¾—åˆ°çš„ç»“æœ
    """
    current = 3
    mu = np.zeros(N)

    for i in range(N):
        sim = one_mh_iteration(current,sigma)
        mu[i] = sim["next_stop"][0]
        current = sim["next_stop"][0]
    
    return pd.DataFrame({"iteration": range(1,N+1), # range(start,end) è¿™é‡Œå¯¹åº”1ï¼ŒN+1ï¼Œæ‰ä¼šä½¿å¾—iterationæ•°åˆ—ä»1å¼€å§‹ï¼Œä¾¿äºç†è§£
                         'mu': mu})
```

```python
# è°ƒç”¨å®šä¹‰å¥½çš„å‡½æ•°ï¼Œå°†é‡‡æ ·æ¬¡æ•°è®¾ä¸º5000ï¼Œå‡åŒ€åˆ†å¸ƒçš„ä¸€åŠå®½åº¦è®¾ä¸º1
np.random.seed(84735)
mh_simulation = mh_tour(N=5000)
mh_simulation.tail() #.tail()ä¸ºæŸ¥çœ‹ç»“æœçš„æœ€åå‡ è¡Œï¼Œ()é»˜è®¤ä¸º5è¡Œ
```

<style>
.center 
{
  width: auto;
  display: table;
  margin-left: auto;
  margin-right: auto;
}
</style>
<div class="center">

| | iteration | mu |
| :-----------: | :-----------: |:-----------: |
|4995|4996|4.528634|
|4996|4997|4.528634|
|4997|4998|4.745413|
|4998|4999|5.847077|
|4999|5000|5.847077|
</div>

**é‡‡æ ·ç»“æœå›¾ç¤º**

```python
import matplotlib.pyplot as plt

#ç”Ÿæˆä¸€è¡Œä¸¤åˆ—çš„ç”»å¸ƒ
fig, axs = plt.subplots(1, 2, figsize=(20, 5))

#density plotï¼šåœ¨ç¬¬ä¸€åˆ—ç»˜åˆ¶å‡ºé‡‡æ ·ç»“æœçš„åˆ†å¸ƒ
axs[0].hist(mh_simulation["mu"], 
            edgecolor = "white",
            color="grey",
            alpha = 0.7,
            bins = 20,
            density = True)
axs[0].set_xlabel("mu", fontsize=16)
axs[0].set_ylabel("density", fontsize=16)

# ç»˜åˆ¶åˆ†å¸ƒå¤–å›´çº¿æ¡
x_norm = np.linspace(2,10,10000)                  
y_norm = st.norm.pdf(x_norm, loc=mh_simulation["mu"].mean(), scale=mh_simulation["mu"].std())

axs[0].plot(x_norm, y_norm, color='blue')

#trace plotï¼šåœ¨ç¬¬äºŒåˆ—ç»˜åˆ¶å‡ºæ¯ä¸€æ¬¡çš„é‡‡æ ·ç»“æœ
axs[1].plot(mh_simulation["iteration"], mh_simulation["mu"],
            color="grey",)
axs[1].set_xlabel("iteration", fontsize=16)
axs[1].set_ylabel("mu", fontsize=16)
```

![alt text](image-8.png)

æˆ‘ä»¬å¯ä»¥ä½¿ç”¨ arviz ç®€åŒ–è¿™ä¸ªç»˜å›¾çš„è¿‡ç¨‹

```python
import arviz as az
import matplotlib.pyplot as plt

ax = az.plot_trace({"mu":mh_simulation["mu"]})

ax[0, 0].set_xlim(2, 10)
```

![alt text](image-9.png)

### è°ƒè¯•(Tuning)Metropolis-Hastings ç®—æ³•

åœ¨å»ºè®®åˆ†å¸ƒ$\mu_{n+1}|\mu_n \sim Normal(\mu_n,\sigma)$ä¸­ï¼Œ$\sigma$åæ˜ äº†å»ºè®®é€‰é¡¹çš„åˆ†å¸ƒå®½åº¦ï¼Œå¯¹å®ƒçš„é€‰æ‹©ä¹Ÿä¼šå½±å“é©¬å°”ç§‘å¤«é“¾çš„è¡¨ç°

ğŸ¤”æˆ‘ä»¬è¿˜æ˜¯ä½¿ç”¨MHç®—æ³•ï¼Œè¯·ä½ åˆ¤æ–­ä¸‰ç§ä¸åŒçš„$\sigma$åˆ†åˆ«å¯¹åº”ä¸‹é¢çš„å“ªäº›è½¨è¿¹å›¾å’Œå¯†åº¦å›¾ï¼Ÿ

- $\sigma$=0.01

- $\sigma=1$

- $\sigma$=100

![alt text](image-10.png)

å¯ä»¥ç»“åˆä»¥ä¸‹ä»£ç è¿›è¡Œåˆ¤æ–­:

```python
import numpy as np
import matplotlib.pyplot as plt
import arviz as az
import scipy.stats as st
import pandas as pd

def one_mh_iteration(current, sigma = 1):

    """
    defåé¢ä¸ºå‡½æ•°å€¼ï¼Œcurrentä¸ºè¾“å…¥å€¼ï¼Œä½œä¸ºå»ºè®®åˆ†å¸ƒ(æ­£æ€åˆ†å¸ƒ)çš„å‡å€¼
    
    æ¥ä¸‹æ¥çš„ä»£ç å’Œä¹‹å‰ä¸€æ ·

    return åˆ™æ˜¯è¯¥å‡½æ•°è¿”å›çš„å€¼ï¼Œæˆ‘ä»¬å°†å»ºè®®å€¼ï¼Œæ¥å—æ¦‚ç‡ï¼Œå’Œä¸‹ä¸€ä¸ªä½ç½®è¿™ä¸‰ä¸ªå€¼ç»„æˆäº†ä¸€ä¸ªæ•°æ®æ¡†è¿›è¡Œè¿”å›
    """
    proposal = st.norm(current, sigma).rvs()

    prior = st.norm(loc = 3, scale = 1)
    def likelihood(theta):
        # å‡è®¾æ•°æ® Y ä¸º 6
        Y = 6
        return st.norm(loc = theta, scale = 0.75).pdf(Y)
        
    proposal_posterior = prior.pdf(proposal) * likelihood(proposal)
    current_posterior = prior.pdf(current) * likelihood(current)
    alpha = min(1,proposal_posterior/current_posterior)
    next_stop = np.random.choice([proposal, current], 1, p=[alpha,1-alpha])
    return pd.DataFrame({"proposal":[proposal],
                         "alpha":[alpha], 
                         "next_stop":[next_stop[0]]})

def mh_tour(N, sigma = 1):

    """
    Nä¸ºè¿­ä»£æ¬¡æ•°ï¼Œsigmaä¸ºæ­£æ€å»ºè®®åˆ†å¸ƒçš„æ ‡å‡†å·®

    æˆ‘ä»¬åœ¨å•æ¬¡é‡‡æ ·å‡½æ•°çš„åŸºç¡€ä¸Šå åŠ äº†ä¸€ä¸ªå¾ªç¯
    å°†æ¯æ¬¡çš„é‡‡æ ·ç»“æœå­˜åœ¨mu[i]ä¸­ï¼Œ
    åœ¨æ¯æ¬¡é‡‡æ ·ç»“æŸåï¼Œå°†é‡‡æ ·ç»“æœæ›¿æ¢ä¸ºå½“å‰ä½ç½®

    è¿”å›å€¼ä¸ºè¿­ä»£æ¬¡æ•°ï¼Œå’Œæ¯æ¬¡é‡‡æ ·å¾—åˆ°çš„ç»“æœ
    """
    current = 3
    mu = np.zeros(N)

    for i in range(N):
        sim = one_mh_iteration(current,sigma)
        mu[i] = sim["next_stop"][0]
        current = sim["next_stop"][0]
    
    return pd.DataFrame({"iteration": range(1,N+1),
                         'mu': mu})
```

```python
#===========================================================================
#                            è¯·ä¿®æ”¹ ... ä¸­çš„å€¼ã€‚
#===========================================================================
np.random.seed(84735)

mh_simulation = mh_tour(N=5000, sigma= ...)
az.plot_trace({"mu": mh_simulation["mu"]})
```

```python
#===========================================================================
#                            å¯ä»¥è‡ªè¡Œå¤åˆ¶ä»£ç å¤šè¯•å‡ æ¬¡
#===========================================================================
mh_simulation = mh_tour(N=5000, sigma= ...)
az.plot_trace({"mu": mh_simulation["mu"]})
```

**æ€»ç»“**

- å½“$\sigma$=0.01æ—¶ï¼š

å»ºè®®åˆ†å¸ƒçš„èŒƒå›´å¾ˆçª„ï¼Œæ¯”å¦‚$Normal(3,0.001)$ï¼Œè¿™ä¼šå¯¼è‡´ä¸‹ä¸€ä¸ªå»ºè®®å€¼å’Œå½“å‰å€¼éå¸¸æ¥è¿‘ï¼Œåˆ™$f(\mu')L(\mu'|y)â‰ˆf(\mu)L(\mu|y)$

$$
\alpha = min \{ 1,\frac{f(\mu')L(\mu'|y)}{f(\mu)L(\mu|y)}\} â‰ˆ min \{ 1,1\} =1
$$

é‚£ä¹ˆæˆ‘ä»¬å¾ˆå®¹æ˜“æ¥å—ä¸‹ä¸€ä¸ªé‡‡æ ·å€¼ï¼Œä½†å°½ç®¡é©¬å°”ç§‘å¤«é“¾ä¸€ç›´åœ¨è½¬ç§»ï¼Œä½†æ¢ç´¢çš„èŒƒå›´å¤ªçª„äº†ï¼Œæˆ‘ä»¬å¯ä»¥çœ‹åˆ°é‡‡æ ·ä¸€ç›´åœ¨3é™„è¿‘

- å½“$\sigma=100$æ—¶ï¼š

ç±»ä¼¼çš„ï¼Œæˆ‘ä»¬å¯ä»¥æ¨çŸ¥æ­¤æ—¶å»ºè®®åˆ†å¸ƒçš„èŒƒå›´å¤ªå®½äº†ï¼Œè¶…å‡ºäº†$\mu$å¯èƒ½çš„å–å€¼

ä¸‹ä¸€ä¸ªå»ºè®®å€¼å’Œå½“å‰å€¼é—´éš”å¤ªè¿œï¼Œè¿™ä¼šå¯¼è‡´æˆ‘ä»¬ç»å¸¸æ‹’ç»ä¸‹ä¸€ä¸ªé‡‡æ ·å€¼ï¼Œå¤šæ¬¡åœåœ¨å½“å‰ä½ç½®ã€‚

- æœ€åï¼Œæ¨è MCMC è®²è§£æœ€å¥½çš„è§†é¢‘(æ²¡æœ‰ä¹‹ä¸€)ï¼šã€è’™ç‰¹å¡æ´›ï¼ˆMonte Carlo, MCMCï¼‰æ–¹æ³•çš„åŸç†å’Œåº”ç”¨ã€‘ https://www.bilibili.com/video/BV17D4y1o7J2/?share_source=copy_web&vd_source=4b5b4646c3f53f1b80954c381226c913

å¦‚æœè¿˜æ˜¯ä¸æ‡‚ MCMC åŸç†ï¼Œé‚£æ”¾å¼ƒä¹Ÿè¡Œ.....

ä¸äº†è§£ MCMC åŸç†ï¼Œå¹¶ä¸å½±å“å¯¹äºå®ƒçš„ä½¿ç”¨ã€‚

**å°ç»“**

æ— è®ºæ˜¯åœ¨è¿™äº›ç›¸å¯¹ç®€å•çš„å•å‚æ•°æ¨¡å‹è®¾ç½®ä¸­ï¼Œè¿˜æ˜¯åœ¨æ›´å¤æ‚çš„æ¨¡å‹è®¾ç½®ä¸­ï¼ŒMetropolis-Hastings ç®—æ³•éƒ½æ˜¯é€šè¿‡ä¸¤æ­¥ä¹‹é—´çš„è¿­ä»£ï¼Œä»åéªŒä¸­äº§ç”Ÿè¿‘ä¼¼æ ·æœ¬ï¼š

- è®¾å®šå»ºè®®åˆ†å¸ƒ

- æ ¹æ®å»ºè®®åˆ†å¸ƒçš„å‚æ•°ã€æœªæ ‡å‡†åŒ–åéªŒè®¡ç®—æ¥å—ç‡

æœ¬èŠ‚è¯¾æˆ‘ä»¬åªè€ƒè™‘äº†ä¸€ç§ MCMC ç®—æ³•ï¼Œå³ Metropolis-Hastingsã€‚è¿™ç§ç®—æ³•è™½ç„¶åŠŸèƒ½å¼ºå¤§ï¼Œä½†ä¹Ÿæœ‰å…¶å±€é™æ€§ã€‚

- åœ¨ä»¥åçš„ç« èŠ‚ä¸­ï¼Œæˆ‘ä»¬çš„è´å¶æ–¯æ¨¡å‹å°†å¢åŠ å¤§é‡å‚æ•°ã€‚è°ƒæ•´ Metropolis-Hastings ç®—æ³•ä»¥å……åˆ†æ¢ç´¢æ¯ä¸ªå‚æ•°ä¼šå˜å¾—å¾ˆç¬¨é‡ã€‚

- ç„¶è€Œï¼Œå³ä½¿ Metropolis-Hastings ç®—æ³•çš„å®ç”¨æ€§è¾¾åˆ°äº†æé™ï¼Œå®ƒä»ç„¶æ˜¯ä¸€å¥—æ›´çµæ´»çš„ MCMC å·¥å…·çš„åŸºç¡€ï¼ŒåŒ…æ‹¬è‡ªé€‚åº” Metropolis-Hastingsã€Gibbs å’Œ Hamiltonian Monte Carlo (HMC) ç®—æ³•ã€‚å…¶ä¸­ï¼ŒHMC æ˜¯ pymc é»˜è®¤ä½¿ç”¨çš„ç®—æ³•ã€‚